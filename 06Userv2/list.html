<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="../lib/jquery.min.js"></script>
    <script type="text/javascript" src="../lib/osql.js"></script>

    <script>
        osql.requireLogin();//すべてのページに入れる．google認証をして，osql.connect()や，osql.getMe()を使えるようにしてくれる．

        $(document).ready(function () {
            execSelect();
        });
        var spl;
        var objects;
        var objects_l;
        var old_objects_l

        async function execSelect() {
            //userリストを表示
            sql = 'select * from Users';
            objects = await osql.connect(sql);
            console.log(objects);
            var html = '';
            html = html + '<table border="1">';
            for (var i = 0; i < objects.length; i++) {
                html = html + '<tr>';
                var object = objects[i];
                html = html + '<td>' + object.id + '</td>';
                html = html + '<td>' + object.name + '</td>';
                html = html + '<td>' + '<a href="update.html?userid=' + object.id + '">変更</a>' + '</td>';
                html = html + '<td>' + '<button onclick="buttondeletePressed(' + object.id + ')">削除</button></td>';
                html = html + '</tr>';
            }
            html = html + '</table>';
            //成功判定のためにリストの長さを代入する
            objects_l = objects.length;
            document.getElementById('result').innerHTML = html;
            console.log(objects_l);
        }
        function confirmdelete(id) {
            //削除するときの最終確認
            var wc = window.confirm("本当に削除しますか？");
            if (wc == true) {
                deleteuserid(id);
            } else {
                old_objects_l = objects_l;
            }
        }

        async function buttondeletePressed(id) {
            await confirmdelete(id);
            await execSelect();
            alert();

        }

        async function deleteuserid(id) {
            //idのデータを削除する
            //削除後のobjects_lの長さに変わるため、置き換える
            old_objects_l = objects_l;
            var delete_sql = `delete from Users where id="${id}"`;
            var objects_d = await osql.connect(delete_sql);
            console.log(objects_l);
            await execSelect();
            alert();

        }

        async function delete_data() {
            //削除後のobjects_lの長さに変わるため、置き換える
            old_objects_l = objects_l;
            var d_id = document.getElementById('tf1').value;
            var delete_sql = `delete from Users where id="${d_id}"`;
            var objects_d = await osql.connect(delete_sql);
            console.log(objects_l);
        }
        async function button1Pressed() {
            await delete_data();
            await execSelect();
            alert();
        }
        function alert() {
            if (objects_l == old_objects_l) {
                document.getElementById('result_d').innerHTML = 'データがないか、削除がキャンセルされました';
            } else {
                document.getElementById('result_d').innerHTML = '削除しました';
            }
        }
    </script>

</head>

<body>
    <h1>Users</h1>
    ID:<input id="tf1" value="" type="textfield"><button onclick="button1Pressed()">削除</button>
    <p id="result">xxxx</p>
    <p id="result_d"></p>
</body>

</html>